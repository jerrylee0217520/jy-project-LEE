<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>佳元松江社區每日營運儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script async defer src="https://apis.google.com/js/api.js?onload=gapiLoaded"></script>
    <script async defer src="https://accounts.google.com/gsi/client?onload=gisLoaded"></script>

    <style>
        /* --- 全局設計系統 --- */
        :root {
            --primary-color: #00A6A6;
            --secondary-color: #E55934;
            --accent-color: #FAD46B;
            --background-start: #F0F4F8;
            --background-end: #D9E2EC;
            --card-bg: rgba(255, 255, 255, 0.6);
            --text-dark: #1A202C;
            --text-medium: #4A5568;
            --text-light: #718096;
            --border-color: rgba(255, 255, 255, 0.8);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-image: linear-gradient(120deg, var(--background-start) 0%, var(--background-end) 100%);
            color: var(--text-dark);
        }

        /* --- 動畫效果 --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* --- 卡片與佈局 --- */
        .card, .kpi-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.4s ease;
        }
        .card:hover, .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 40px 0 var(--shadow-color);
        }

        /* --- 標題與文字 --- */
        .main-title {
            font-weight: 900;
            font-size: 3rem;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.05);
        }
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            position: relative;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 2px;
        }
        .section-subtitle { color: var(--text-medium); }

        /* --- KPI 卡片美化 --- */
        .kpi-card { padding: 2rem; }
        .kpi-icon { width: 48px; height: 48px; margin: 0 auto 1rem auto; color: var(--primary-color); }
        .kpi-value { font-size: 3.5rem; font-weight: 900; line-height: 1; color: var(--text-dark); }
        .kpi-label { font-size: 1rem; font-weight: 500; color: var(--text-light); margin-top: 0.75rem; }

        /* --- 表單元素美化 --- */
        .form-input {
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }
        .form-input:focus {
            background-color: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 166, 166, 0.2);
            outline: none;
        }
        .btn-primary {
            background-image: linear-gradient(45deg, var(--primary-color) 0%, #00c4c4 100%);
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px 0 rgba(0, 166, 166, 0.3);
            transition: all 0.3s ease;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px 0 rgba(0, 166, 166, 0.4);
        }
        
        /* --- 全新日期導航器樣式 --- */
        .date-navigator {
            max-width: 28rem;
            padding: 0.75rem;
        }
        #date-selector {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            border: 2px solid transparent;
            text-align: center;
            padding: 0.5rem 1rem;
        }
        #date-selector::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }
        .date-nav-btn {
            background-color: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-medium);
            transition: all 0.3s ease;
        }
        .date-nav-btn:hover:not(:disabled) {
            background-color: #fff;
            color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .date-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* --- 表格美化 --- */
        table { border-radius: 1rem; overflow: hidden; }
        th { background-color: rgba(243, 244, 246, 0.7); font-weight: 700; color: var(--text-dark); text-transform: uppercase; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: rgba(230, 245, 245, 0.5); }

        /* --- 訊息提示框 --- */
        #toast { position: fixed; top: 20px; right: 20px; padding: 1rem 1.5rem; border-radius: 0.75rem; color: white; font-weight: 600; z-index: 10000; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s, transform 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        #toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { background-image: linear-gradient(45deg, var(--primary-color) 0%, #00c4c4 100%); }
        .toast-error { background-image: linear-gradient(45deg, var(--secondary-color) 0%, #ff7e61 100%); }
    </style>
</head>
<body class="antialiased">
    <div id="toast"></div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
        <header class="text-center mb-16">
            <h1 class="main-title mb-4">佳元松江社區 營運儀表板</h1>
            
            <div class="card date-navigator mx-auto flex items-center justify-between space-x-2">
                <button id="prev-day-btn" class="date-nav-btn" disabled>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <input type="date" id="date-selector" class="form-input flex-grow" disabled>
                <button id="next-day-btn" class="date-nav-btn" disabled>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <p class="text-lg text-gray-500 mt-4">當前日期：<span id="displayDate" class="font-bold"></span></p>
            <div class="mt-6">
                <button id="auth-button" class="btn-primary px-6 py-3 text-lg">登入 Google</button>
            </div>
            <p id="user-status" class="mt-3 text-gray-500">正在初始化...</p>
        </header>

        <section id="input-form" class="mb-16 hidden">
            <main class="card max-w-4xl mx-auto p-6 sm:p-8">
                <div class="form-section">
                    <h2 class="text-2xl font-semibold mb-4 text-[#E55934]">社區動態輸入</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="totalRenovation" class="block mb-2 form-label">總裝潢施作戶數</label><input type="number" id="totalRenovation" class="form-input" value="14"></div>
                        <div><label for="newRenovation" class="block mb-2 form-label">本日申請裝潢戶數</label><input type="number" id="newRenovation" class="form-input" value="0"></div>
                        <div><label for="renovationRetired" class="block mb-2 form-label">本日裝潢驗退戶數</label><input type="number" id="renovationRetired" class="form-input" value="0"></div>
                        <div><label for="totalRenovationAccum" class="block mb-2 form-label">裝潢總計（累計）</label><input type="number" id="totalRenovationAccum" class="form-input" value="20"></div>
                        <div><label for="totalRenovationRetiredAccum" class="block mb-2 form-label">已驗退戶（累計）</label><input type="number" id="totalRenovationRetiredAccum" class="form-input" value="6"></div>
                        <div><label for="newMoveIn" class="block mb-2 form-label">本日交屋戶數</label><input type="text" id="newMoveIn" class="form-input" value="0"></div>
                        <div><label for="totalHouseholds" class="block mb-2 form-label">總戶數</label><input type="number" id="totalHouseholds" class="form-input" value="40"></div>
                    </div>
                </div>
                <div class="form-section"><h2 class="text-2xl font-semibold mb-4 text-[#E55934]">停車紀錄</h2><div id="parking-records-container" class="space-y-4"></div><button id="add-parking-record-btn" class="mt-4 text-[#00A6A6] font-semibold">＋ 新增停車紀錄</button></div>
                <div class="form-section"><h2 class="text-2xl font-semibold mb-4 text-[#E55934]">每日清點</h2><div class="space-y-2"><div class="flex items-center"><input type="checkbox" id="check1" checked class="h-4 w-4 text-[#00A6A6] focus:ring-[#00A6A6] border-gray-300 rounded"><label for="check1" class="ml-2 block text-sm text-gray-900">公共區域門窗安全檢查</label></div><div class="flex items-center"><input type="checkbox" id="check2" class="h-4 w-4 text-[#00A6A6] focus:ring-[#00A6A6] border-gray-300 rounded"><label for="check2" class="ml-2 block text-sm text-gray-900">無郵件及包裹點交</label></div><div class="flex items-center"><input type="checkbox" id="check3" checked class="h-4 w-4 text-[#00A6A6] focus:ring-[#00A6A6] border-gray-300 rounded"><label for="check3" class="ml-2 block text-sm text-gray-900">施工圍籬與施工車輛停放位置確認</label></div></div></div>
                <div class="form-section"><h2 class="text-2xl font-semibold mb-4 text-[#E55934]">今日工作事項</h2><div id="tasks-container" class="space-y-4"></div><button id="addTaskBtn" class="mt-4 text-[#00A6A6] font-semibold">＋ 新增工作事項</button></div>
                <div class="form-section">
                    <h2 class="text-2xl font-semibold mb-4 text-[#E55934]">人員編制</h2>
                    <div class="space-y-4">
                        <div><label for="managerName" class="block mb-2 form-label">經理姓名</label><input type="text" id="managerName" class="form-input" value="李俊煌"></div>
                        <div><label for="todayShift" class="block mb-2 form-label">今日出勤</label><input type="text" id="todayShift" class="form-input" value="早班 08:00–17:00"></div>
                        <div><label for="tomorrowShift" class="block mb-2 form-label">明日出勤</label><input type="text" id="tomorrowShift" class="form-input" value="休假"></div>
                        <div><label for="shiftNotes" class="block mb-2 form-label">備註</label><textarea id="shiftNotes" class="form-input" rows="4">兼任保全巡場、門禁與安檢工作</textarea></div>
                    </div>
                </div>
                <div class="form-section">
                    <h2 class="text-2xl font-semibold mb-4 text-[#00A6A6]">Google Sheets 匯出設定</h2>
                    <div>
                        <label for="spreadsheet-id" class="block mb-2 form-label">目標 Google Sheet ID</label>
                        <input type="text" id="spreadsheet-id" class="form-input" placeholder="請貼上您的 Google Sheet ID" value="1DwcrgFncaocK3fil-lT-j5InTV7NwlBjEZjDF_OuhFU">
                    </div>
                </div>
                <div class="text-center space-x-4 mt-6">
                    <button id="save-log-btn" class="btn-primary">儲存日誌</button>
                    <button id="export-to-sheets-btn" class="btn-primary">匯出至 Google Sheets</button>
                    <button id="generate-csv-btn" class="btn-primary">產生 CSV (備用)</button>
                </div>
            </main>
        </section>

        <section id="dashboard-display" class="mb-16">
            <h2 class="section-title text-3xl">社區核心數據</h2>
            <p class="section-subtitle">即時掌握社區的關鍵數據，包含總戶數與裝潢進度概覽。</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 max-w-5xl mx-auto">
                <div class="kpi-card fade-in"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" /></svg></div><div id="kpi-total-households" class="kpi-value">-</div><div class="kpi-label">總戶數</div></div>
                <div class="kpi-card fade-in" style="animation-delay: 0.1s;"><div class="kpi-icon" style="color: var(--secondary-color);"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.43 2.43a4.5 4.5 0 008.636-2.021.75.75 0 00-1.425-.245zM12.75 4.5a4.5 4.5 0 014.5 4.5v8.25a.75.75 0 01-1.5 0v-8.25a3 3 0 00-3-3H6.75a.75.75 0 010-1.5h6z" /></svg></div><div id="kpi-total-renovation" class="kpi-value">-</div><div class="kpi-label">總裝潢施作戶數</div></div>
                <div class="kpi-card fade-in" style="animation-delay: 0.2s;"><div class="kpi-icon" style="color: var(--accent-color);"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg></div><div id="kpi-total-renovation-accum" class="kpi-value">-</div><div class="kpi-label">裝潢總計(累計)</div></div>
                <div class="kpi-card fade-in" style="animation-delay: 0.3s;"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div><div id="kpi-renovation-retired-accum" class="kpi-value">-</div><div class="kpi-label">已驗退戶(累計)</div></div>
            </div>
        </section>
        <section id="parking-display" class="mb-16"><div class="card max-w-5xl mx-auto p-4 sm:p-6"><h2 class="section-title text-3xl">停車紀錄</h2><p class="section-subtitle">以下為今日社區停車紀錄清單。</p><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">車牌號碼</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">戶別</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">入場時間</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出場時間</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">停放時長(分鐘)</th></tr></thead><tbody id="parking-table-body"></tbody></table></div></div></section>
        <section id="renovation-progress-display" class="mb-16"><div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center max-w-5xl mx-auto"><div class="card md:col-span-1 p-4 sm:p-6"><h2 class="section-title text-3xl">本日裝潢動態</h2><p class="section-subtitle">此圓環圖顯示了已申請裝潢的戶別中，正在施工中與已完工驗退的比例。</p><div class="chart-container"><canvas id="renovationChart"></canvas></div></div><div class="card md:col-span-1 p-4 sm:p-6"><h2 class="section-title text-3xl">本日人員編制</h2><p class="section-subtitle">今日值勤人員的詳細資訊與明日班表。</p><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">職位</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">人員姓名</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">今日出勤</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">明日出勤</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th></tr></thead><tbody id="staffing-table-body"></tbody></table></div></div></div></section>
        <section id="daily-checklist-display" class="mb-16"><div class="card max-w-5xl mx-auto p-4 sm:p-6"><h2 class="section-title text-3xl">每日清點</h2><p class="section-subtitle">以下為今日工作日誌中的清點項目與其完成狀態。</p><div id="checklist-kpi-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div></div></section>
        <section id="daily-tasks-display" class="mb-16"><div class="card max-w-5xl mx-auto p-4 sm:p-6"><h2 class="section-title text-3xl">今日工作事項</h2><p class="section-subtitle">以下為今日工作日誌的詳細事項清單。</p><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">事項</th></tr></thead><tbody id="tasks-table-body"></tbody></table></div></div></section>

        <footer class="text-center text-gray-500 text-sm mt-12 pb-4">
            <p>Powered by MAGIC JERRY</p>
        </footer>
    </div>

    <script type="module">
        // --- Firebase 模組 ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithRedirect, getRedirectResult, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- 全局設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
            authDomain: "jy-2025.firebaseapp.com",
            projectId: "jy-2025",
            storageBucket: "jy-2025.appspot.com",
            messagingSenderId: "640527461851",
            appId: "1:640527461851:web:eed9f82d698275371fcbfe",
        };
        
        const ADMIN_UIDS = ["KcaxVmcqI3RzxWdhCl2dhVGPxti1"];
        
        const GOOGLE_API_KEY = "AIzaSyAF90JqId5m1BRfdtc7TlTKWnYI_o5dQAs";
        const GOOGLE_CLIENT_ID = "948134512517-9thbq35n96ljei8hqks1ngn1mjqquopm.apps.googleusercontent.com";
        const DISCOVERY_DOC = "https://sheets.googleapis.com/$discovery/rest?version=v4";
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";


        // --- 應用程式核心物件 ---
        const App = {
            db: null,
            auth: null,
            user: null,
            gapiInited: false,
            gisInited: false,
            tokenClient: null,
            renovationChart: null,
            taskCount: 0,
            parkingRecordCount: 0,
            elements: {},

            init() {
                const firebaseApp = initializeApp(firebaseConfig);
                this.auth = getAuth(firebaseApp);
                this.db = getFirestore(firebaseApp);

                this.cacheDOMElements();
                this.bindPermanentEventListeners();
                this.initDateSelector();
                this.initChart();
                this.listenForAuthStateChanges();
                
                window.gapiLoaded = () => gapi.load('client', this.initializeGapiClient.bind(this));
                window.gisLoaded = this.initializeGisClient.bind(this);
            },
            
            async initializeGapiClient() {
                try {
                    await gapi.client.init({
                        apiKey: GOOGLE_API_KEY,
                        discoveryDocs: [DISCOVERY_DOC],
                    });
                    this.gapiInited = true;
                    console.log("GAPI client initialized.");
                    this.checkGoogleApiReady();
                } catch (err) {
                    console.error("Error initializing GAPI client:", err);
                    this.showToast('GAPI client 初始化失敗', 'error');
                }
            },

            initializeGisClient() {
                try {
                    this.tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: SCOPES,
                        callback: async (tokenResponse) => {
                            if (tokenResponse && tokenResponse.access_token) {
                                const spreadsheetId = this.elements.spreadsheetIdInput.value;
                                await this.appendDataToSheet(spreadsheetId);
                            } else {
                                console.error("Authorization failed or was cancelled.");
                                this.showToast('Google 授權失敗或被取消。', 'error');
                            }
                        },
                    });
                    this.gisInited = true;
                    console.log("GIS client initialized.");
                    this.checkGoogleApiReady();
                } catch (err) {
                    console.error("Error initializing GIS client:", err);
                    this.showToast('GIS client 初始化失敗', 'error');
                }
            },
            
            checkGoogleApiReady() {
                if (this.gapiInited && this.gisInited) {
                    console.log("Google APIs are fully loaded and initialized.");
                    this.showToast('Google API 準備就緒！');
                    this.updateAuthUI(this.user);
                }
            },

            cacheDOMElements() {
                this.elements = {
                    toast: document.getElementById('toast'),
                    authButton: document.getElementById('auth-button'),
                    userStatus: document.getElementById('user-status'),
                    inputForm: document.getElementById('input-form'),
                    saveLogBtn: document.getElementById('save-log-btn'),
                    dateSelector: document.getElementById('date-selector'),
                    displayDate: document.getElementById('displayDate'),
                    prevDayBtn: document.getElementById('prev-day-btn'),
                    nextDayBtn: document.getElementById('next-day-btn'),
                    spreadsheetIdInput: document.getElementById('spreadsheet-id'),
                    exportToSheetsBtn: document.getElementById('export-to-sheets-btn'),
                };
            },

            bindPermanentEventListeners() {
                this.elements.authButton.addEventListener('click', () => {
                    if (this.user && !this.user.isAnonymous) {
                        signOut(this.auth);
                    } else {
                        // 【登入修正】: 改用 Redirect 模式
                        const provider = new GoogleAuthProvider();
                        signInWithRedirect(this.auth, provider);
                    }
                });

                this.elements.dateSelector.addEventListener('change', (event) => this.fetchLogByDate(event.target.value));
                this.elements.prevDayBtn.addEventListener('click', () => this.changeDate(-1));
                this.elements.nextDayBtn.addEventListener('click', () => this.changeDate(1));
                this.elements.saveLogBtn.addEventListener('click', () => this.saveLogToFirestore());
                this.elements.exportToSheetsBtn.addEventListener('click', () => this.exportToSheets());
                
                document.getElementById('generate-csv-btn').addEventListener('click', () => this.generateCsv());
                document.getElementById('addTaskBtn').addEventListener('click', () => this.addTask());
                document.getElementById('add-parking-record-btn').addEventListener('click', () => this.addParkingRecord());
                document.querySelectorAll('#input-form input, #input-form textarea').forEach(input => {
                    input.addEventListener('input', () => this.updateDashboardFromForm());
                });
            },
            
            initDateSelector() {
                const today = new Date();
                today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
                this.elements.dateSelector.value = today.toISOString().split('T')[0];
            },

            initChart() {
                const ctx = document.getElementById('renovationChart').getContext('2d');
                this.renovationChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: ['施工中', '已驗退'], datasets: [{ label: '戶數', data: [0, 0], backgroundColor: ['#00A6A6', '#E55934'], borderColor: 'rgba(255, 255, 255, 0.6)', borderWidth: 4, hoverOffset: 8 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { padding: 20, font: { size: 14, family: "'Noto Sans TC', sans-serif" }, color: '#4A5568' } } } }
                });
            },

            listenForAuthStateChanges() {
                this.elements.userStatus.innerText = '正在載入 Google API...';
                
                // 【登入修正】: 增加 getRedirectResult 來處理跳轉回來的結果
                getRedirectResult(this.auth)
                    .then((result) => {
                        if (result) {
                            console.log("Redirect result processed.", result.user);
                        }
                    }).catch((error) => {
                        console.error("Error processing redirect result:", error);
                    });

                onAuthStateChanged(this.auth, (user) => {
                    if (user) {
                        this.user = user;
                        this.handleAuthStateChange(user);
                    } else {
                        signInAnonymously(this.auth).catch(error => {
                            console.error("匿名登入失敗:", error);
                            this.elements.userStatus.innerText = "錯誤：無法連接至資料庫";
                        });
                    }
                });
            },

            handleAuthStateChange(user) {
                if(this.gapiInited && this.gisInited) {
                    this.updateAuthUI(user);
                }
                this.elements.dateSelector.disabled = false;
                this.elements.prevDayBtn.disabled = false;
                this.fetchLogByDate(this.elements.dateSelector.value);
            },

            updateDateNavButtonsState() {
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                const selectedDate = new Date(this.elements.dateSelector.value + 'T00:00:00');
                this.elements.nextDayBtn.disabled = selectedDate >= today;
            },

            showToast(message, type = 'success') {
                this.elements.toast.textContent = message;
                this.elements.toast.className = `toast-${type}`;
                this.elements.toast.classList.add('show');
                setTimeout(() => {
                    this.elements.toast.classList.remove('show');
                }, 3000);
            },
            
            updateAuthUI(user) {
                if (!this.gapiInited || !this.gisInited) {
                    this.elements.userStatus.innerText = '正在載入 Google API...';
                    return;
                }
                
                this.elements.userStatus.innerText = '訪客模式，登入以編輯日誌。';
                
                if (user && !user.isAnonymous) {
                    this.elements.authButton.innerText = '登出';
                    if (ADMIN_UIDS.includes(user.uid)) {
                        this.elements.userStatus.innerText = `管理員模式：${user.displayName}`;
                        this.elements.inputForm.classList.remove('hidden');
                    } else {
                        this.elements.userStatus.innerText = `訪客模式：${user.displayName} (無編輯權限)`;
                        this.elements.inputForm.classList.add('hidden');
                    }
                } else {
                    this.elements.authButton.innerText = '管理員登入';
                    this.elements.inputForm.classList.add('hidden');
                }
            },

            async saveLogToFirestore() {
                if (!this.user || !ADMIN_UIDS.includes(this.user.uid)) return this.showToast('您沒有權限儲存！', 'error');
                const data = this.getFormData();
                if (!data.date) return this.showToast('請選擇日期！', 'error');
                this.elements.saveLogBtn.disabled = true;
                try {
                    await setDoc(doc(this.db, "daily_logs", data.date), data);
                    this.showToast(`日誌 ${data.date} 已成功儲存！`);
                } catch (e) {
                    console.error("儲存錯誤:", e);
                    this.showToast(e.code === 'permission-denied' ? "權限不足" : `儲存失敗: ${e.message}`, 'error');
                } finally {
                    this.elements.saveLogBtn.disabled = false;
                }
            },

            async fetchLogByDate(date) {
                if (!date) return;
                try {
                    const docRef = doc(this.db, 'daily_logs', date);
                    const docSnap = await getDoc(docRef);
                    const isUserAdmin = this.user && ADMIN_UIDS.includes(this.user.uid);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.updateDashboard(data);
                        if (isUserAdmin) this.updateInputForm(data);
                    } else {
                        const defaultData = this.getFormData();
                        this.updateDashboard(defaultData);
                        if (isUserAdmin) this.clearInputForm();
                    }
                } catch (error) {
                    console.error("讀取錯誤:", error);
                    this.showToast(error.code === 'permission-denied' ? "權限不足" : "讀取資料失敗！", 'error');
                    this.updateDashboard(null);
                } finally {
                    this.updateDateNavButtonsState();
                }
            },
            
            getFormData() {
                const date = this.elements.dateSelector.value;
                const totalRenovation = document.getElementById('totalRenovation').value;
                const newRenovation = document.getElementById('newRenovation').value;
                const renovationRetired = document.getElementById('renovationRetired').value;
                const totalRenovationAccum = document.getElementById('totalRenovationAccum').value;
                const totalRenovationRetiredAccum = document.getElementById('totalRenovationRetiredAccum').value;
                const newMoveIn = document.getElementById('newMoveIn').value;
                const totalHouseholds = document.getElementById('totalHouseholds').value;
                const managerName = document.getElementById('managerName').value;
                const todayShift = document.getElementById('todayShift').value;
                const tomorrowShift = document.getElementById('tomorrowShift').value;
                const shiftNotes = document.getElementById('shiftNotes').value;
                const check1 = document.getElementById('check1').checked;
                const check2 = document.getElementById('check2').checked;
                const check3 = document.getElementById('check3').checked;
                const tasks = Array.from(document.querySelectorAll('#tasks-container input')).map(el => el.value).filter(val => val.trim() !== '');
                const parkingRecords = [];
                document.querySelectorAll('#parking-records-container > div').forEach(div => {
                    const record = {};
                    div.querySelectorAll('.parking-input').forEach(input => { record[input.dataset.field] = input.value; });
                    if (Object.values(record).some(v => v)) parkingRecords.push(record);
                });
                return { date, community: { totalRenovation, newRenovation, renovationRetired, totalRenovationAccum, totalRenovationRetiredAccum, newMoveIn, totalHouseholds }, checklist: { check1, check2, check3 }, tasks, staff: { managerName, todayShift, tomorrowShift, shiftNotes }, parking: parkingRecords };
            },

            updateDashboard(data) {
                const dateObj = new Date(this.elements.dateSelector.value + 'T00:00:00');
                this.elements.displayDate.innerText = dateObj.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });

                if (!data) {
                    this.elements.displayDate.innerText = '請選擇日期或該日無資料';
                    ['kpi-total-households', 'kpi-total-renovation', 'kpi-total-renovation-accum', 'kpi-renovation-retired-accum'].forEach(id => document.getElementById(id).innerText = '-');
                    ['checklist-kpi-container', 'staffing-table-body', 'tasks-table-body', 'parking-table-body'].forEach(id => document.getElementById(id).innerHTML = '');
                    if (this.renovationChart) {
                        this.renovationChart.data.datasets[0].data = [0, 0];
                        this.renovationChart.update();
                    }
                    return;
                }
                
                document.getElementById('kpi-total-households').innerText = data.community.totalHouseholds || '-';
                document.getElementById('kpi-total-renovation').innerText = data.community.totalRenovation || '-';
                document.getElementById('kpi-total-renovation-accum').innerText = data.community.totalRenovationAccum || '-';
                document.getElementById('kpi-renovation-retired-accum').innerText = data.community.totalRenovationRetiredAccum || '-';

                document.getElementById('checklist-kpi-container').innerHTML = `
                    <div class="kpi-card text-center"><div class="kpi-value ${data.checklist.check1 ? 'text-[#00A6A6]' : 'text-[#E55934]'}">${data.checklist.check1 ? '✓' : 'X'}</div><div class="kpi-label">公共區域門窗安全檢查</div></div>
                    <div class="kpi-card text-center"><div class="kpi-value ${data.checklist.check2 ? 'text-[#00A6A6]' : 'text-[#E55934]'}">${data.checklist.check2 ? '✓' : 'X'}</div><div class="kpi-label">無郵件及包裹點交</div></div>
                    <div class="kpi-card text-center"><div class="kpi-value ${data.checklist.check3 ? 'text-[#00A6A6]' : 'text-[#E55934]'}">${data.checklist.check3 ? '✓' : 'X'}</div><div class="kpi-label">施工圍籬與施工車輛停放位置確認</div></div>
                `;
                document.getElementById('staffing-table-body').innerHTML = `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">經理</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.managerName || '-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.todayShift || '-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.tomorrowShift || '-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.shiftNotes || '-'}</td></tr>`;

                const tasksTableBody = document.getElementById('tasks-table-body');
                tasksTableBody.innerHTML = '';
                (data.tasks || []).forEach(task => { if (task) tasksTableBody.insertAdjacentHTML('beforeend', `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task}</td></tr>`); });

                const parkingTableBody = document.getElementById('parking-table-body');
                parkingTableBody.innerHTML = '';
                (data.parking || []).forEach(r => parkingTableBody.insertAdjacentHTML('beforeend', `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.carPlate||'-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.huBei||'-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.entryTime||'-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.exitTime||'-'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.duration||'-'}</td></tr>`));

                if (this.renovationChart) {
                    const retired = parseInt(data.community.totalRenovationRetiredAccum) || 0;
                    const inProgress = (parseInt(data.community.totalRenovationAccum) || 0) - retired;
                    this.renovationChart.data.datasets[0].data = [inProgress < 0 ? 0 : inProgress, retired];
                    this.renovationChart.update();
                }
            },
            
            updateInputForm(data) {
                if (!data) return;
                document.getElementById('totalRenovation').value = data.community.totalRenovation || '';
                document.getElementById('newRenovation').value = data.community.newRenovation || '';
                document.getElementById('renovationRetired').value = data.community.renovationRetired || '';
                document.getElementById('totalRenovationAccum').value = data.community.totalRenovationAccum || '';
                document.getElementById('totalRenovationRetiredAccum').value = data.community.totalRenovationRetiredAccum || '';
                document.getElementById('newMoveIn').value = data.community.newMoveIn || '';
                document.getElementById('totalHouseholds').value = data.community.totalHouseholds || '';
                document.getElementById('check1').checked = data.checklist.check1 || false;
                document.getElementById('check2').checked = data.checklist.check2 || false;
                document.getElementById('check3').checked = data.checklist.check3 || false;
                document.getElementById('managerName').value = data.staff.managerName || '';
                document.getElementById('todayShift').value = data.staff.todayShift || '';
                document.getElementById('tomorrowShift').value = data.staff.tomorrowShift || '';
                document.getElementById('shiftNotes').value = data.staff.shiftNotes || '';
                
                const tasksContainer = document.getElementById('tasks-container');
                tasksContainer.innerHTML = '';
                this.taskCount = 0;
                (data.tasks || []).forEach(task => this.addTask(task));
                if ((data.tasks || []).length === 0) this.addTask();
                
                const parkingRecordsContainer = document.getElementById('parking-records-container');
                parkingRecordsContainer.innerHTML = '';
                this.parkingRecordCount = 0;
                (data.parking || []).forEach(record => this.addParkingRecord(record));
                if ((data.parking || []).length === 0) this.addParkingRecord();
            },
            
            clearInputForm() {
                document.querySelectorAll('#input-form input, #input-form textarea').forEach(el => { el.type === 'checkbox' ? el.checked = false : el.value = ''; });
                const tasksContainer = document.getElementById('tasks-container');
                tasksContainer.innerHTML = '';
                this.taskCount = 0;
                this.addTask();
                const parkingRecordsContainer = document.getElementById('parking-records-container');
                parkingRecordsContainer.innerHTML = '';
                this.parkingRecordCount = 0;
                this.addParkingRecord();
            },
            
            updateDashboardFromForm() { this.updateDashboard(this.getFormData()); },

            addTask(taskValue = '') {
                const container = document.getElementById('tasks-container');
                const newIndex = this.taskCount++;
                const newDiv = document.createElement('div');
                newDiv.innerHTML = `<label for="task${newIndex}" class="block mb-2 form-label">事項 ${newIndex + 1}</label><input type="text" id="task${newIndex}" class="form-input" value="${taskValue}">`;
                newDiv.querySelector('input').addEventListener('input', () => this.updateDashboardFromForm());
                container.appendChild(newDiv);
            },
            
            addParkingRecord(record = {}) {
                const container = document.getElementById('parking-records-container');
                const index = this.parkingRecordCount++;
                const div = document.createElement('div');
                div.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 border-t pt-4";
                div.innerHTML = `
                    <div><label class="block mb-2 form-label">車牌號碼</label><input type="text" class="form-input parking-input" data-field="carPlate" value="${record.carPlate || ''}"></div>
                    <div><label class="block mb-2 form-label">戶別</label><input type="text" class="form-input parking-input" data-field="huBei" value="${record.huBei || ''}"></div>
                    <div><label class="block mb-2 form-label">入場時間</label><input type="time" class="form-input parking-input" data-field="entryTime" value="${record.entryTime || ''}"></div>
                    <div><label class="block mb-2 form-label">出場時間</label><input type="time" class="form-input parking-input" data-field="exitTime" value="${record.exitTime || ''}"></div>
                    <div><label class="block mb-2 form-label">停放時長(分鐘)</label><input type="number" class="form-input parking-input bg-gray-200" data-field="duration" value="${record.duration || ''}" readonly></div>
                `;
                
                const entryTimeInput = div.querySelector('[data-field="entryTime"]');
                const exitTimeInput = div.querySelector('[data-field="exitTime"]');
                const durationInput = div.querySelector('[data-field="duration"]');

                const calculateDuration = () => {
                    if (entryTimeInput.value && exitTimeInput.value) {
                        const entry = new Date(`1970-01-01T${entryTimeInput.value}:00`);
                        const exit = new Date(`1970-01-01T${exitTimeInput.value}:00`);
                        let diff = (exit.getTime() - entry.getTime()) / 60000;
                        if (diff < 0) diff += 24 * 60;
                        durationInput.value = Math.round(diff);
                    } else {
                        durationInput.value = '';
                    }
                    this.updateDashboardFromForm();
                };

                entryTimeInput.addEventListener('change', calculateDuration);
                exitTimeInput.addEventListener('change', calculateDuration);
                
                div.querySelectorAll('input').forEach(input => { 
                    if(input.dataset.field !== 'entryTime' && input.dataset.field !== 'exitTime') {
                        input.addEventListener('input', () => this.updateDashboardFromForm());
                    }
                });
                container.appendChild(div);
            },
            
            changeDate(offset) {
                const dateString = this.elements.dateSelector.value;
                const currentDate = new Date(dateString + 'T00:00:00');
                currentDate.setDate(currentDate.getDate() + offset);
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                this.elements.dateSelector.value = `${year}-${month}-${day}`;
                this.elements.dateSelector.dispatchEvent(new Event('change'));
            },

            generateCsv() {
                const data = this.getFormData();
                const logDate = data.date;
                const check1Status = data.checklist.check1 ? '✓' : '-';
                const check2Status = data.checklist.check2 ? '✓' : '-';
                const check3Status = data.checklist.check3 ? '✓' : '-';
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += `佳元松江社區｜工作日誌｜${logDate}\n\n`;
                csvContent += "一、社區動態\n項目,數量（戶）\n";
                csvContent += `總裝潢施作,${data.community.totalRenovation}\n本日申請裝潢,${data.community.newRenovation}\n本日裝潢驗退,${data.community.renovationRetired}\n裝潢總計（累計）,${data.community.totalRenovationAccum}\n已驗退戶（累計）,${data.community.totalRenovationRetiredAccum}\n\n`;
                csvContent += "二、社區基本數據\n項目,數值\n";
                csvContent += `地址,松江路252巷10號\n總戶數,${data.community.totalHouseholds}\n本日交屋戶數,${data.community.newMoveIn}\n\n`;
                csvContent += "三、人員編制\n職位,人員姓名,今日出勤,明日出勤,備註\n";
                csvContent += `經理,${data.staff.managerName},"${data.staff.todayShift}","${data.staff.tomorrowShift}","${data.staff.shiftNotes}"\n\n`;
                csvContent += "四、每日清點\n項目,完成狀態\n";
                csvContent += `公共區域門窗安全檢查,${check1Status}\n無郵件及包裹點交,${check2Status}\n施工圍籬與施工車輛停放位置確認,${check3Status}\n\n`;
                csvContent += "五、今日工作事項\n";
                data.tasks.forEach(task => { csvContent += `"${task}"\n`; });
                csvContent += "\n";
                csvContent += "六、停車紀錄\n車牌號碼,戶別,入場時間,出場時間,停放時長(分鐘)\n";
                data.parking.forEach(record => {
                     csvContent += `${record.carPlate || ''},${record.huBei || ''},${record.entryTime || ''},${record.exitTime || ''},${record.duration || ''}\n`;
                });
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `佳元松江社區｜工作日誌｜${logDate.replace(/-/g, '')}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },

            exportToSheets() {
                const spreadsheetId = this.elements.spreadsheetIdInput.value;
                if (!spreadsheetId) {
                    return this.showToast('請先輸入目標 Google Sheet 的 ID！', 'error');
                }
                if (!this.gapiInited || !this.gisInited) {
                    return this.showToast('Google API 尚未準備就緒，請稍後再試。', 'error');
                }
                
                // 【授權修正】: 檢查現有 Token，若無則請求
                if (gapi.client.getToken() === null) {
                    this.tokenClient.requestAccessToken({ prompt: 'consent' });
                } else {
                    this.appendDataToSheet(spreadsheetId);
                }
            },

            async appendDataToSheet(spreadsheetId) {
                const data = this.getFormData();
                const logDate = data.date;

                // 準備總覽資料
                const summaryValues = [
                    [
                        logDate, data.community.totalRenovation, data.community.newRenovation,
                        data.community.renovationRetired, data.community.totalRenovationAccum,
                        data.community.totalRenovationRetiredAccum, data.community.newMoveIn,
                        data.staff.managerName, data.staff.todayShift, data.staff.tomorrowShift,
                        data.staff.shiftNotes, data.tasks.join('; ')
                    ]
                ];

                // 準備停車紀錄資料
                const parkingValues = data.parking.map(p => [
                    logDate, p.carPlate || '', p.huBei || '', p.entryTime || '', p.exitTime || '', p.duration || ''
                ]);

                try {
                    const requests = [];

                    // 建立寫入總覽的請求
                    requests.push(gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: spreadsheetId,
                        range: '每日總覽!A1',
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: summaryValues },
                    }));

                    // 如果有停車紀錄，才建立寫入停車紀錄的請求
                    if (parkingValues.length > 0) {
                        requests.push(gapi.client.sheets.spreadsheets.values.append({
                            spreadsheetId: spreadsheetId,
                            range: '停車詳細紀錄!A1',
                            valueInputOption: 'USER_ENTERED',
                            resource: { values: parkingValues },
                        }));
                    }
                    
                    // 平行執行所有寫入請求
                    await Promise.all(requests);
                    
                    this.showToast(`成功將 ${logDate} 的日誌匯出至 Google Sheets！`);
                } catch (err) {
                    console.error('寫入 Google Sheets 失敗:', err);
                    this.showToast(`匯出失敗: ${err.result.error.message}`, 'error');
                }
            }
        };

        // --- 【GSheets 修正】: 全局回呼函式，用於在 Google API 腳本載入後初始化 ---
        window.gapiLoaded = function() {
            gapi.load('client', () => App.initializeGapiClient());
        }

        window.gisLoaded = function() {
            App.initializeGisClient();
        }

        // --- 應用程式啟動點 ---
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>