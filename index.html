<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>佳元松江社區每日營運儀表板</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <script async src="https://apis.google.com/js/api.js"></script>
  <script async src="https://accounts.google.com/gsi/client"></script>

  <style>
    :root{
      --primary-color:#00A6A6;--secondary-color:#E55934;--accent-color:#FAD46B;
      --background-start:#F0F4F8;--background-end:#D9E2EC;--card-bg:rgba(255,255,255,.6);
      --text-dark:#1A202C;--text-medium:#4A5568;--text-light:#718096;--border-color:rgba(255,255,255,.8);--shadow-color:rgba(0,0,0,.1)
    }
    body{font-family:'Noto Sans TC',sans-serif;background-image:linear-gradient(120deg,var(--background-start) 0%,var(--background-end) 100%);color:var(--text-dark)}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .fade-in{animation:fadeIn .6s ease-out forwards}
    .card,.kpi-card{background:var(--card-bg);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid var(--border-color);border-radius:1.5rem;box-shadow:0 8px 32px 0 var(--shadow-color);transition:transform .3s ease,box-shadow .4s ease}
    .card:hover,.kpi-card:hover{transform:translateY(-8px);box-shadow:0 16px 40px 0 var(--shadow-color)}
    .main-title{font-weight:900;font-size:3rem;background:linear-gradient(45deg,var(--primary-color),var(--secondary-color));-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:2px 2px 10px rgba(0,0,0,.05)}
    .section-title{font-size:2rem;font-weight:700;color:var(--text-dark);position:relative;padding-bottom:.75rem;margin-bottom:1rem}
    .section-title::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:50px;height:4px;background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));border-radius:2px}
    .section-subtitle{color:var(--text-medium)}
    .kpi-card{padding:2rem}.kpi-icon{width:48px;height:48px;margin:0 auto 1rem auto;color:var(--primary-color)}.kpi-value{font-size:3.5rem;font-weight:900;line-height:1;color:var(--text-dark)}.kpi-label{font-size:1rem;font-weight:500;color:var(--text-light);margin-top:.75rem}
    .form-input{background-color:rgba(255,255,255,.5);border:1px solid var(--border-color);border-radius:.75rem;transition:all .3s ease}
    .form-input:focus{background-color:#fff;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(0,166,166,.2);outline:none}
    .btn-primary{background-image:linear-gradient(45deg,var(--primary-color) 0%,#00c4c4 100%);border:none;border-radius:.75rem;box-shadow:0 4px 15px 0 rgba(0,166,166,.3);transition:all .3s ease;padding:.75rem 1.25rem;color:white;font-weight:700}
    .btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 7px 20px 0 rgba(0,166,166,.4)}
    .date-navigator{max-width:28rem;padding:.75rem}
    #date-selector{font-size:1.25rem;font-weight:700;color:var(--text-dark);border:2px solid transparent;text-align:center;padding:.5rem 1rem}
    #date-selector::-webkit-calendar-picker-indicator{cursor:pointer;filter:invert(.5)}
    .date-nav-btn{background-color:rgba(255,255,255,.5);border:1px solid var(--border-color);border-radius:50%;width:44px;height:44px;display:flex;align-items:center;justify-content:center;color:var(--text-medium);transition:all .3s ease}
    .date-nav-btn:hover:not(:disabled){background-color:#fff;color:var(--primary-color);box-shadow:0 4px 10px rgba(0,0,0,.1)}
    .date-nav-btn:disabled{opacity:.5;cursor:not-allowed}
    table{border-radius:1rem;overflow:hidden}
    th{background-color:rgba(243,244,246,.7);font-weight:700;color:var(--text-dark);text-transform:uppercase;letter-spacing:.05em}
    tr:last-child td{border-bottom:none}tr:hover{background-color:rgba(230,245,245,.5)}
    #toast{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:.75rem;color:white;font-weight:600;z-index:10000;opacity:0;transform:translateY(-20px);transition:opacity .3s,transform .3s;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    #toast.show{opacity:1;transform:translateY(0)}.toast-success{background-image:linear-gradient(45deg,var(--primary-color) 0%,#00c4c4 100%)}.toast-error{background-image:linear-gradient(45deg,var(--secondary-color) 0%,#ff7e61 100%)}
  </style>
</head>
<body class="antialiased">
  <div id="toast"></div>

  <div class="container mx-auto p-4 sm:p-6 md:p-8">
    <header class="text-center mb-16">
      <h1 class="main-title mb-4">佳元松江社區 營運儀表板</h1>

      <div class="card date-navigator mx-auto flex items-center justify-between space-x-2">
        <button id="prev-day-btn" class="date-nav-btn" disabled>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        <input type="date" id="date-selector" class="form-input flex-grow" disabled>
        <button id="next-day-btn" class="date-nav-btn" disabled>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
      </div>

      <p class="text-lg text-gray-500 mt-4">當前日期：<span id="displayDate" class="font-bold"></span></p>
      <div class="mt-6">
        <button id="auth-button" class="btn-primary px-6 py-3 text-lg">登入 Google</button>
      </div>
      <p id="user-status" class="mt-3 text-gray-500">正在初始化...</p>
    </header>

    <section id="input-form" class="mb-16 hidden">
      <main class="card max-w-4xl mx-auto p-6 sm:p-8">
        <div class="form-section">
          <h2 class="text-2xl font-semibold mb-4 text-[#E55934]">社區動態輸入</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><label class="block mb-2">總裝潢施作戶數</label><input type="number" id="totalRenovation" class="form-input" value="14"></div>
            <div><label class="block mb-2">本日申請裝潢戶數</label><input type="number" id="newRenovation" class="form-input" value="0"></div>
            <div><label class="block mb-2">本日裝潢驗退戶數</label><input type="number" id="renovationRetired" class="form-input" value="0"></div>
            <div><label class="block mb-2">裝潢總計（累計）</label><input type="number" id="totalRenovationAccum" class="form-input" value="20"></div>
            <div><label class="block mb-2">已驗退戶（累計）</label><input type="number" id="totalRenovationRetiredAccum" class="form-input" value="6"></div>
            <div><label class="block mb-2">本日交屋戶數</label><input type="text" id="newMoveIn" class="form-input" value="0"></div>
            <div><label class="block mb-2">總戶數</label><input type="number" id="totalHouseholds" class="form-input" value="40"></div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="text-2xl font-semibold mb-4 text-[#E55934]">停車紀錄</h2>
          <div id="parking-records-container" class="space-y-2 text-gray-600">
            </div>
          <input type="file" id="csv-file-input" class="hidden" accept=".csv">
          <button id="import-csv-btn" class="mt-4 btn-primary">從 CSV 匯入停車紀錄</button>
        </div>

        <div class="form-section">
          <h2 class="text-2xl font-semibold mb-4 text-[#E55934]">每日清點</h2>
          <div class="space-y-2">
            <div class="flex items-center"><input type="checkbox" id="check1" checked class="h-4 w-4 text-[#00A6A6] border-gray-300 rounded"><label for="check1" class="ml-2 text-sm">公共區域門窗安全檢查</label></div>
            <div class="flex items-center"><input type="checkbox" id="check2" class="h-4 w-4 text-[#00A6A6] border-gray-300 rounded"><label for="check2" class="ml-2 text-sm">無郵件及包裹點交</label></div>
            <div class="flex items-center"><input type="checkbox" id="check3" checked class="h-4 w-4 text-[#00A6A6] border-gray-300 rounded"><label for="check3" class="ml-2 text-sm">施工圍籬與施工車輛停放位置確認</label></div>
          </div>
        </div>

        <div class="form-section">
          <h2 class="text-2xl font-semibold mb-4 text-[#E55934]">今日工作事項</h2>
          <div id="tasks-container" class="space-y-4"></div>
          <button id="addTaskBtn" class="mt-4 text-[#00A6A6] font-semibold">＋ 新增工作事項</button>
        </div>

        <div class="form-section">
          <h2 class="text-2xl font-semibold mb-4 text-[#E55934]">人員編制</h2>
          <div class="space-y-4">
            <div><label class="block mb-2">經理姓名</label><input type="text" id="managerName" class="form-input" value="李俊煌"></div>
            <div><label class="block mb-2">今日出勤</label><input type="text" id="todayShift" class="form-input" value="早班 08:00–17:00"></div>
            <div><label class="block mb-2">明日出勤</label><input type="text" id="tomorrowShift" class="form-input" value="休假"></div>
            <div><label class="block mb-2">備註</label><textarea id="shiftNotes" class="form-input" rows="4">兼任保全巡場、門禁與安檢工作</textarea></div>
          </div>
        </div>

        <div class="text-center space-x-4 mt-6">
          <button id="save-log-btn" class="btn-primary">儲存日誌</button>
          <button id="export-to-sheets-btn" class="btn-primary">匯出至 Google Sheets</button>
          <button id="generate-csv-btn" class="btn-primary">產生 CSV (備用)</button>
        </div>
      </main>
    </section>

    <section id="dashboard-display" class="mb-16">
      <h2 class="section-title text-3xl">社區核心數據</h2>
      <p class="section-subtitle">即時掌握社區的關鍵數據，包含總戶數與裝潢進度概覽。</p>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 max-w-5xl mx-auto">
        <div class="kpi-card fade-in"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21"/></svg></div><div id="kpi-total-households" class="kpi-value">-</div><div class="kpi-label">總戶數</div></div>
        <div class="kpi-card fade-in" style="animation-delay:.1s"><div class="kpi-icon" style="color:var(--secondary-color)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.43 2.43a4.5 4.5 0 008.636-2.021.75.75 0 00-1.425-.245zM12.75 4.5a4.5 4.5 0 014.5 4.5v8.25a.75.75 0 01-1.5 0v-8.25a3 3 0 00-3-3H6.75a.75.75 0 010-1.5h6z"/></svg></div><div id="kpi-total-renovation" class="kpi-value">-</div><div class="kpi-label">總裝潢施作戶數</div></div>
        <div class="kpi-card fade-in" style="animation-delay:.2s"><div class="kpi-icon" style="color:var(--accent-color)"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z"/></svg></div><div id="kpi-total-renovation-accum" class="kpi-value">-</div><div class="kpi-label">裝潢總計(累計)</div></div>
        <div class="kpi-card fade-in" style="animation-delay:.3s"><div class="kpi-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div id="kpi-renovation-retired-accum" class="kpi-value">-</div><div class="kpi-label">已驗退戶(累計)</div></div>
      </div>
    </section>

    <section id="parking-display" class="mb-16">
      <div class="card max-w-5xl mx-auto p-4 sm:p-6">
        <h2 class="section-title text-3xl">停車紀錄</h2>
        <p class="section-subtitle">以下為今日社區停車紀錄清單。</p>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead><tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">車牌號碼</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">戶別</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">入場時間</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">出場時間</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">停放時長(分鐘)</th>
            </tr></thead>
            <tbody id="parking-table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="renovation-progress-display" class="mb-16">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center max-w-5xl mx-auto">
        <div class="card md:col-span-1 p-4 sm:p-6">
          <h2 class="section-title text-3xl">本日裝潢動態</h2>
          <p class="section-subtitle">此圓環圖顯示了已申請裝潢的戶別中，正在施工中與已完工驗退的比例。</p>
          <div class="chart-container"><canvas id="renovationChart"></canvas></div>
        </div>
        <div class="card md:col-span-1 p-4 sm:p-6">
          <h2 class="section-title text-3xl">本日人員編制</h2>
          <p class="section-subtitle">今日值勤人員的詳細資訊與明日班表。</p>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead><tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">職位</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">人員姓名</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">今日出勤</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">明日出勤</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">備註</th>
              </tr></thead>
              <tbody id="staffing-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="daily-checklist-display" class="mb-16">
      <div class="card max-w-5xl mx-auto p-4 sm:p-6">
        <h2 class="section-title text-3xl">每日清點</h2>
        <p class="section-subtitle">以下為今日工作日誌中的清點項目與其完成狀態。</p>
        <div id="checklist-kpi-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </section>

    <section id="daily-tasks-display" class="mb-16">
      <div class="card max-w-5xl mx-auto p-4 sm:p-6">
        <h2 class="section-title text-3xl">今日工作事項</h2>
        <p class="section-subtitle">以下為今日工作日誌的詳細事項清單。</p>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">事項</th></tr></thead>
            <tbody id="tasks-table-body"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="text-center text-gray-500 text-sm mt-12 pb-4">
      <p>Powered by MAGIC JERRY</p>
    </footer>
  </div>

  <script type="module">
    // --- Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
      getAuth, onAuthStateChanged, signInAnonymously,
      GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // --- Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDeRHsloR1iY0_bzpYbPzdCiBljGfck98k",
      authDomain: "jy-2025.firebaseapp.com",
      projectId: "jy-2025",
      storageBucket: "jy-2025.appspot.com",
      messagingSenderId: "640527461851",
      appId: "1:640527461851:web:eed9f82d698275371fcbfe",
    };

    // 管理員（UID 白名單）
    const ADMIN_UIDS = ["KcaxVmcqI3RzxWdhCl2dhVGPxti1"];

    // --- 固定 Google Sheet ID（不再顯示/輸入） ---
    const DEFAULT_SHEET_ID = "1DwcrgFncaocK3fil-lT-j5InTV7NwlBjEZjDF_OuhFU";

    // --- Google APIs (Sheets) ---
    const GOOGLE_API_KEY = "AIzaSyAF90JqId5m1BRfdtc7TlTKWnYI_o5dQAs";
    const GOOGLE_CLIENT_ID = "948134512517-9thbq35n96ljei8hqks1ngn1mjqquopm.apps.googleusercontent.com";
    const DISCOVERY_DOC = "https://sheets.googleapis.com/$discovery/rest?version=v4";
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    // --- App ---
    const App = {
      db:null, auth:null, user:null,
      gapiReady:false, gisReady:false, tokenClient:null,
      renovationChart:null, taskCount:0,
      parkingData: [],
      elements:{},

      init(){
        const app = initializeApp(firebaseConfig);
        this.auth = getAuth(app);
        this.db = getFirestore(app);

        this.cacheDOMElements();
        this.bindEvents();
        this.initDateSelector();
        this.initChart();
        this.initAuthWatcher();
        this.waitGoogleApis();
      },

      cacheDOMElements(){
        this.elements = {
          toast:document.getElementById('toast'),
          authButton: document.getElementById('auth-button'), // <-- CORRECTED LINE
          userStatus:document.getElementById('user-status'),
          inputForm:document.getElementById('input-form'),
          saveLogBtn:document.getElementById('save-log-btn'),
          dateSelector:document.getElementById('date-selector'),
          displayDate:document.getElementById('displayDate'),
          prevDayBtn:document.getElementById('prev-day-btn'),
          nextDayBtn:document.getElementById('next-day-btn'),
          exportToSheetsBtn:document.getElementById('export-to-sheets-btn'),
          importCsvBtn: document.getElementById('import-csv-btn'),
          csvFileInput: document.getElementById('csv-file-input'),
          parkingRecordsContainer: document.getElementById('parking-records-container'),
        };
      },

      bindEvents(){
        this.elements.authButton.addEventListener('click', async ()=>{
          const u = this.auth.currentUser;
          if (u && !u.isAnonymous) { await signOut(this.auth); return; }
          try{
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt:'select_account' });
            await signInWithPopup(this.auth, provider);
          }catch(e){ console.error('Google 登入錯誤:', e); }
        });

        this.elements.dateSelector.addEventListener('change', (e)=> this.fetchLogByDate(e.target.value));
        this.elements.prevDayBtn.addEventListener('click', ()=> this.changeDate(-1));
        this.elements.nextDayBtn.addEventListener('click', ()=> this.changeDate(1));
        this.elements.saveLogBtn.addEventListener('click', ()=> this.saveLogToFirestore());
        this.elements.exportToSheetsBtn.addEventListener('click', ()=> this.exportToSheets());

        document.getElementById('generate-csv-btn').addEventListener('click', ()=> this.generateCsv());
        document.getElementById('addTaskBtn').addEventListener('click', ()=> this.addTask());
        
        this.elements.importCsvBtn.addEventListener('click', () => this.elements.csvFileInput.click());
        this.elements.csvFileInput.addEventListener('change', (e) => this.handleCsvImport(e));

        document.querySelectorAll('#input-form input[type="text"], #input-form input[type="number"], #input-form textarea').forEach(input=>{
          input.addEventListener('input', ()=> this.updateDashboardFromForm());
        });
         document.querySelectorAll('#input-form input[type="checkbox"]').forEach(input=>{
          input.addEventListener('change', ()=> this.updateDashboardFromForm());
        });
      },

      initDateSelector(){
        const today = new Date();
        today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
        this.elements.dateSelector.value = today.toISOString().split('T')[0];
      },

      initChart(){
        const ctx = document.getElementById('renovationChart').getContext('2d');
        this.renovationChart = new Chart(ctx,{
          type:'doughnut',
          data:{labels:['施工中','已驗退'],datasets:[{label:'戶數',data:[0,0],backgroundColor:['#00A6A6','#E55934'],borderColor:'rgba(255,255,255,.6)',borderWidth:4,hoverOffset:8}]},
          options:{responsive:true,maintainAspectRatio:false,cutout:'70%',plugins:{legend:{position:'bottom',labels:{padding:20,font:{size:14,family:"'Noto Sans TC', sans-serif"},color:'#4A5568'}}}}
        });
      },

      initAuthWatcher(){
        this.elements.userStatus.innerText = '正在載入 Google API...';

        onAuthStateChanged(this.auth, (user)=>{
          console.log('[DEBUG] uid=', user?.uid, 'email=', user?.email);
          this.user = user || null;
          this.updateAuthUI();
          if (!user) {
            signInAnonymously(this.auth).catch(err=>{
              console.error('匿名登入失敗:', err);
              this.elements.userStatus.innerText = "錯誤：無法連接至資料庫";
            });
          } else {
            this.elements.dateSelector.disabled = false;
            this.elements.prevDayBtn.disabled = false;
            this.fetchLogByDate(this.elements.dateSelector.value);
          }
        });
      },

      updateAuthUI(){
        const user = this.user;
        const isAdmin = user && !user.isAnonymous && ADMIN_UIDS.includes(user.uid);

        if (user && !user.isAnonymous) {
          this.elements.authButton.innerText = '登出';
          if (isAdmin) {
            this.elements.userStatus.innerText = `管理員模式：${user.displayName || user.email || '已登入'}`;
            this.elements.inputForm.classList.remove('hidden');
          } else {
            this.elements.userStatus.innerText = `訪客模式：${user.displayName || user.email || '已登入'} (無編輯權限)`;
            this.elements.inputForm.classList.add('hidden');
          }
        } else {
          this.elements.userStatus.innerText = '訪客模式，登入以編輯日誌。';
          this.elements.authButton.innerText = '管理員登入';
          this.elements.inputForm.classList.add('hidden');
        }
      },

      waitGoogleApis(){
        const waitFor = (cond, cb)=>{ const t=setInterval(()=>{ if(cond()){clearInterval(t); cb();}},50); };
        waitFor(()=> window.gapi && window.gapi.load, ()=>{
          gapi.load('client', async ()=>{
            try{
              await gapi.client.init({ apiKey: GOOGLE_API_KEY, discoveryDocs:[DISCOVERY_DOC] });
              this.gapiReady = true;
              this.maybeApisReady();
            }catch(e){ console.error('GAPI 初始化失敗', e); this.showToast('GAPI 初始化失敗','error'); }
          });
        });
        waitFor(()=> window.google && window.google.accounts && window.google.accounts.oauth2, ()=>{
          try{
            this.tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: GOOGLE_CLIENT_ID,
              scope: SCOPES,
              callback: async (tokenResponse)=>{
                if (tokenResponse && tokenResponse.access_token) {
                  await this.appendDataToSheet(DEFAULT_SHEET_ID);
                } else {
                  this.showToast('Google 授權失敗或被取消。','error');
                }
              },
              prompt: ''
            });
            this.gisReady = true;
            this.maybeApisReady();
          }catch(e){ console.error('GIS 初始化失敗', e); this.showToast('GIS 初始化失敗','error'); }
        });
      },
      maybeApisReady(){
        if (this.gapiReady && this.gisReady) {
          this.showToast('Google API 準備就緒！');
          this.updateAuthUI();
        }
      },

      async saveLogToFirestore(){
        if (!this.user || this.user.isAnonymous || !ADMIN_UIDS.includes(this.user.uid))
          return this.showToast('您沒有權限儲存！', 'error');

        const data = this.getFormData();
        if (!data.date) return this.showToast('請選擇日期！', 'error');
        this.elements.saveLogBtn.disabled = true;
        try{
          await setDoc(doc(this.db,"daily_logs", data.date), data);
          this.showToast(`日誌 ${data.date} 已成功儲存！`);
        }catch(e){
          console.error("儲存錯誤:", e);
          this.showToast(e.code === 'permission-denied' ? "權限不足" : `儲存失敗: ${e.message}`, 'error');
        }finally{
          this.elements.saveLogBtn.disabled = false;
        }
      },

      async fetchLogByDate(date){
        if (!date) return;
        try{
          const docRef = doc(this.db, 'daily_logs', date);
          const snap = await getDoc(docRef);
          const isAdmin = this.user && !this.user.isAnonymous && ADMIN_UIDS.includes(this.user.uid);
          if (snap.exists()) {
            const data = snap.data();
            this.updateDashboard(data);
            if (isAdmin) this.updateInputForm(data);
          } else {
            const defaultData = this.getFormData(); 
            this.updateDashboard(defaultData);
            if (isAdmin) this.clearInputForm();
          }
        }catch(error){
          console.error('讀取錯誤:', error);
          this.showToast(error.code === 'permission-denied' ? "權限不足" : "讀取資料失敗！", 'error');
          this.updateDashboard(null);
        }finally{
          this.updateDateNavButtonsState();
        }
      },
      
      handleCsvImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const text = e.target.result;
            const rows = text.trim().split(/\r?\n/).slice(1);
            
            this.parkingData = rows.map(row => {
                const columns = row.split(',');
                if (columns.length < 5) return null;
                return {
                    carPlate: columns[0].trim(),
                    huBei: columns[1].trim(),
                    entryTime: columns[2].trim(),
                    exitTime: columns[3].trim(),
                    duration: columns[4].trim()
                };
            }).filter(Boolean);

            this.showToast(`成功匯入 ${this.parkingData.length} 筆停車紀錄`, 'success');
            this.renderParkingData();
            this.updateDashboardFromForm();
        };
        reader.onerror = () => this.showToast('讀取檔案失敗', 'error');
        reader.readAsText(file, 'UTF-8');
        event.target.value = '';
      },
      
      renderParkingData() {
        this.elements.parkingRecordsContainer.innerHTML = '';
        if (this.parkingData.length === 0) {
            this.elements.parkingRecordsContainer.innerHTML = '<p>尚未匯入停車紀錄。</p>';
        } else {
            const list = document.createElement('ul');
            list.className = 'list-disc list-inside space-y-1';
            this.parkingData.forEach(r => {
                const item = document.createElement('li');
                item.textContent = `車牌: ${r.carPlate}, 戶別: ${r.huBei}, 時間: ${r.entryTime} - ${r.exitTime}`;
                list.appendChild(item);
            });
            this.elements.parkingRecordsContainer.appendChild(list);
        }

        const parkingBody = document.getElementById('parking-table-body');
        parkingBody.innerHTML = '';
        this.parkingData.forEach(r => {
            parkingBody.insertAdjacentHTML('beforeend', `
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.carPlate || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.huBei || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.entryTime || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.exitTime || '-'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${r.duration || '-'}</td>
              </tr>
            `);
        });
      },

      getFormData(){
        const date = this.elements.dateSelector.value;
        const totalRenovation = document.getElementById('totalRenovation').value;
        const newRenovation = document.getElementById('newRenovation').value;
        const renovationRetired = document.getElementById('renovationRetired').value;
        const totalRenovationAccum = document.getElementById('totalRenovationAccum').value;
        const totalRenovationRetiredAccum = document.getElementById('totalRenovationRetiredAccum').value;
        const newMoveIn = document.getElementById('newMoveIn').value;
        const totalHouseholds = document.getElementById('totalHouseholds').value;
        const managerName = document.getElementById('managerName').value;
        const todayShift = document.getElementById('todayShift').value;
        const tomorrowShift = document.getElementById('tomorrowShift').value;
        const shiftNotes = document.getElementById('shiftNotes').value;
        const check1 = document.getElementById('check1').checked;
        const check2 = document.getElementById('check2').checked;
        const check3 = document.getElementById('check3').checked;
        const tasks = Array.from(document.querySelectorAll('#tasks-container input')).map(el=>el.value).filter(v=>v.trim()!=='');
        
        return {
          date,
          community:{ totalRenovation,newRenovation,renovationRetired,totalRenovationAccum,totalRenovationRetiredAccum,newMoveIn,totalHouseholds },
          checklist:{ check1,check2,check3 },
          tasks,
          staff:{ managerName,todayShift,tomorrowShift,shiftNotes },
          parking: this.parkingData
        };
      },

      updateDashboard(data){
        const dateObj = new Date(this.elements.dateSelector.value + 'T00:00:00');
        this.elements.displayDate.innerText = dateObj.toLocaleDateString('zh-TW',{year:'numeric',month:'long',day:'numeric'});

        if (!data){
          this.elements.displayDate.innerText = '請選擇日期或該日無資料';
          ['kpi-total-households','kpi-total-renovation','kpi-total-renovation-accum','kpi-renovation-retired-accum'].forEach(id=>document.getElementById(id).innerText='-');
          ['checklist-kpi-container','staffing-table-body','tasks-table-body','parking-table-body'].forEach(id=>document.getElementById(id).innerHTML='');
          if (this.renovationChart){ this.renovationChart.data.datasets[0].data=[0,0]; this.renovationChart.update(); }
          return;
        }

        document.getElementById('kpi-total-households').innerText = data.community.totalHouseholds || '-';
        document.getElementById('kpi-total-renovation').innerText = data.community.totalRenovation || '-';
        document.getElementById('kpi-total-renovation-accum').innerText = data.community.totalRenovationAccum || '-';
        document.getElementById('kpi-renovation-retired-accum').innerText = data.community.totalRenovationRetiredAccum || '-';

        document.getElementById('checklist-kpi-container').innerHTML = `
          <div class="kpi-card text-center"><div class="kpi-value ${data.checklist.check1 ? 'text-[#00A6A6]' : 'text-[#E55934]'}">${data.checklist.check1 ? '✓' : 'X'}</div><div class="kpi-label">公共區域門窗安全檢查</div></div>
          <div class="kpi-card text-center"><div class="kpi-value ${data.checklist.check2 ? 'text-[#00A6A6]' : 'text-[#E55934]'}">${data.checklist.check2 ? '✓' : 'X'}</div><div class="kpi-label">無郵件及包裹點交</div></div>
          <div class="kpi-card text-center"><div class="kpi-value ${data.checklist.check3 ? 'text-[#00A6A6]' : 'text-[#E55934]'}">${data.checklist.check3 ? '✓' : 'X'}</div><div class="kpi-label">施工圍籬與施工車輛停放位置確認</div></div>
        `;

        document.getElementById('staffing-table-body').innerHTML = `
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">經理</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.managerName || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.todayShift || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.tomorrowShift || '-'}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.staff.shiftNotes || '-'}</td>
          </tr>
        `;

        const tasksBody = document.getElementById('tasks-table-body');
        tasksBody.innerHTML='';
        (data.tasks||[]).forEach(task=>{ if(task) tasksBody.insertAdjacentHTML('beforeend', `<tr><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task}</td></tr>`); });
        
        this.parkingData = data.parking || [];
        this.renderParkingData();

        if (this.renovationChart){
          const retired = parseInt(data.community.totalRenovationRetiredAccum) || 0;
          const inProgress = (parseInt(data.community.totalRenovationAccum)||0) - retired;
          this.renovationChart.data.datasets[0].data = [inProgress<0?0:inProgress, retired];
          this.renovationChart.update();
        }
      },

      updateInputForm(data){
        if(!data) return;
        document.getElementById('totalRenovation').value = data.community.totalRenovation || '';
        document.getElementById('newRenovation').value = data.community.newRenovation || '';
        document.getElementById('renovationRetired').value = data.community.renovationRetired || '';
        document.getElementById('totalRenovationAccum').value = data.community.totalRenovationAccum || '';
        document.getElementById('totalRenovationRetiredAccum').value = data.community.totalRenovationRetiredAccum || '';
        document.getElementById('newMoveIn').value = data.community.newMoveIn || '';
        document.getElementById('totalHouseholds').value = data.community.totalHouseholds || '';
        document.getElementById('check1').checked = data.checklist.check1 || false;
        document.getElementById('check2').checked = data.checklist.check2 || false;
        document.getElementById('check3').checked = data.checklist.check3 || false;
        document.getElementById('managerName').value = data.staff.managerName || '';
        document.getElementById('todayShift').value = data.staff.todayShift || '';
        document.getElementById('tomorrowShift').value = data.staff.tomorrowShift || '';
        document.getElementById('shiftNotes').value = data.staff.shiftNotes || '';

        const tasksContainer = document.getElementById('tasks-container');
        tasksContainer.innerHTML=''; this.taskCount=0;
        (data.tasks||[]).forEach(task=> this.addTask(task));
        if ((data.tasks||[]).length===0) this.addTask();
        
        this.parkingData = data.parking || [];
        this.renderParkingData();
      },

      clearInputForm(){
        document.querySelectorAll('#input-form input[type="text"], #input-form input[type="number"], #input-form textarea').forEach(el=>{ el.value=''; });
        document.querySelectorAll('#input-form input[type="checkbox"]').forEach(el => { el.checked = false; });
        const t = document.getElementById('tasks-container'); t.innerHTML=''; this.taskCount=0; this.addTask();
        
        this.parkingData = [];
        this.renderParkingData();
      },

      updateDashboardFromForm(){ this.updateDashboard(this.getFormData()); },

      addTask(val=''){
        const c = document.getElementById('tasks-container');
        const i = this.taskCount++;
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        div.innerHTML = `<input type="text" class="form-input w-full" value="${val}" placeholder="新增事項 ${i+1}">`;
        div.querySelector('input').addEventListener('input', ()=> this.updateDashboardFromForm());
        c.appendChild(div);
      },

      changeDate(offset){
        const d = new Date(this.elements.dateSelector.value + 'T00:00:00');
        d.setDate(d.getDate()+offset);
        const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
        this.elements.dateSelector.value = `${y}-${m}-${day}`;
        this.elements.dateSelector.dispatchEvent(new Event('change'));
      },

      updateDateNavButtonsState(){
        const today = new Date(); today.setHours(0,0,0,0);
        const selected = new Date(this.elements.dateSelector.value + 'T00:00:00');
        this.elements.nextDayBtn.disabled = selected >= today;
      },

      generateCsv(){
        const data = this.getFormData();
        const logDate = data.date;
        const c1 = data.checklist.check1 ? '✓' : '-';
        const c2 = data.checklist.check2 ? '✓' : '-';
        const c3 = data.checklist.check3 ? '✓' : '-';
        let csv = "\uFEFF";
        csv += `佳元松江社區｜工作日誌｜${logDate}\n\n`;
        csv += "一、社區動態\n項目,數量（戶）\n";
        csv += `總裝潢施作,${data.community.totalRenovation}\n本日申請裝潢,${data.community.newRenovation}\n本日裝潢驗退,${data.community.renovationRetired}\n裝潢總計（累計）,${data.community.totalRenovationAccum}\n已驗退戶（累計）,${data.community.totalRenovationRetiredAccum}\n\n`;
        csv += "二、社區基本數據\n項目,數值\n";
        csv += `地址,松江路252巷10號\n總戶數,${data.community.totalHouseholds}\n本日交屋戶數,${data.community.newMoveIn}\n\n`;
        csv += "三、人員編制\n職位,人員姓名,今日出勤,明日出勤,備註\n";
        csv += `經理,${data.staff.managerName},${data.staff.todayShift},${data.staff.tomorrowShift},${data.staff.shiftNotes}\n\n`;
        csv += "四、每日清點\n項目,完成狀態\n";
        csv += `公共區域門窗安全檢查,${c1}\n無郵件及包裹點交,${c2}\n施工圍籬與施工車輛停放位置確認,${c3}\n\n`;
        csv += "五、今日工作事項\n";
        data.tasks.forEach(task=>{ csv += `${task}\n`; });
        csv += "\n六、停車紀錄\n車牌號碼,戶別,入場時間,出場時間,停放時長(分鐘)\n";
        data.parking.forEach(r=>{
          csv += `${r.carPlate||''},${r.huBei||''},${r.entryTime||''},${r.exitTime||''},${r.duration||''}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `佳元松江社區｜工作日誌｜${logDate.replace(/-/g,'')}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },

      exportToSheets(){
        if (!this.gapiReady || !this.gisReady) return this.showToast('Google API 尚未準備就緒，請稍後再試。','error');

        const token = gapi.client.getToken();
        if (!token) {
          this.tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
          this.appendDataToSheet(DEFAULT_SHEET_ID);
        }
      },

      async appendDataToSheet(spreadsheetId) {
        this.showToast('正在處理匯出...', 'success');
        const data = this.getFormData();
        const sheetTitle = data.date;
        
        if (!sheetTitle) {
            this.showToast('無法獲取日期，無法建立工作表', 'error');
            return;
        }

        const valuesToWrite = [
            [`佳元松江社區工作日誌 - 日期: ${sheetTitle}`],
            [],
            ["一、社區動態"],
            ["項目", "本日數量", "累計數量"],
            ["總裝潢施作戶數", data.community.totalRenovation, "-"],
            ["本日申請裝潢", data.community.newRenovation, "-"],
            ["本日裝潢驗退", data.community.renovationRetired, "-"],
            ["裝潢總計", "-", data.community.totalRenovationAccum],
            ["已驗退戶", "-", data.community.totalRenovationRetiredAccum],
            ["本日交屋戶數", data.community.newMoveIn, "-"],
            ["總戶數", data.community.totalHouseholds, "-"],
            [],
            ["二、人員編制"],
            ["職位", "姓名", "今日出勤", "明日出勤", "備註"],
            ["經理", data.staff.managerName, data.staff.todayShift, data.staff.tomorrowShift, data.staff.shiftNotes],
            [],
            ["三、每日清點"],
            ["項目", "完成狀態"],
            ["公共區域門窗安全檢查", data.checklist.check1 ? '完成' : '未完成'],
            ["無郵件及包裹點交", data.checklist.check2 ? '完成' : '未完成'],
            ["施工圍籬與施工車輛停放位置確認", data.checklist.check3 ? '完成' : '未完成'],
            [],
            ["四、今日工作事項"],
            ...data.tasks.map(task => [task]),
            [],
            ["五、停車紀錄"],
            ["車牌號碼", "戶別", "入場時間", "出場時間", "停放時長(分鐘)"],
            ...data.parking.map(p => [ p.carPlate || '', p.huBei || '', p.entryTime || '', p.exitTime || '', p.duration || '' ])
        ];

        try {
            const spreadsheet = await gapi.client.sheets.spreadsheets.get({ spreadsheetId });
            const sheetExists = spreadsheet.result.sheets.some(
                s => s.properties.title === sheetTitle
            );

            if (sheetExists) {
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId,
                    range: sheetTitle
                });
                this.showToast('偵測到今日工作表，已清除舊資料...', 'success');
            } else {
                const addSheetRequest = { addSheet: { properties: { title: sheetTitle } } };
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId,
                    resource: { requests: [addSheetRequest] }
                });
                this.showToast(`已成功建立新的工作表: ${sheetTitle}`, 'success');
            }

            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId,
                range: `${sheetTitle}!A1`,
                valueInputOption: 'USER_ENTERED',
                resource: { values: valuesToWrite }
            });

            this.showToast(`成功將日誌匯出至工作表: ${sheetTitle}`, 'success');

        } catch (err) {
            console.error('寫入 Google Sheets 失敗:', err);
            const msg = (err.result && err.result.error && err.result.error.message) ? err.result.error.message : '未知錯誤';
            this.showToast(`匯出失敗: ${msg}`, 'error');
        }
      },

      showToast(msg,type='success'){
        this.elements.toast.textContent = msg;
        this.elements.toast.className = `toast-${type}`;
        this.elements.toast.classList.add('show');
        setTimeout(()=>{ this.elements.toast.classList.remove('show'); }, 3000);
      }
    };

    document.addEventListener('DOMContentLoaded', ()=> App.init());
  </script>
</body>
</html>